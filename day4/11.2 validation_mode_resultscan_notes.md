# Inspecting COPY Validation Results with RESULT_SCAN in Snowflake

## 1) See the raw validation output from the last COPY
```sql
SELECT *
FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
```
Shows the detailed rows Snowflake produced for validation.

### Typical Columns
- FILE – file path in the stage  
- LINE / ROW_NUMBER – row number in file  
- STATUS – LOAD_FAILED, LOAD_SKIPPED, etc.  
- ERROR / ERROR_MESSAGE – reason for failure  
- FIRST_ERROR_COLUMN – column index that failed  
- ROWS_PARSED, ERRORS_SEEN – summary per file  

---

## 2) Persist results to a (temp) table
```sql
CREATE OR REPLACE TEMP TABLE t_validation AS
SELECT *
FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));

SELECT * FROM t_validation LIMIT 50;
```

For permanent audit trail:
```sql
CREATE OR REPLACE TABLE audit.validation_runs AS
SELECT *
FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
```

---

## 3) Filter for failures only
```sql
SELECT *
FROM t_validation
WHERE (ERROR IS NOT NULL OR ERROR_MESSAGE IS NOT NULL OR STATUS ILIKE '%FAIL%');
```

Example: focus on one file
```sql
SELECT *
FROM t_validation
WHERE FILE ILIKE '%OrderDetails_2025-08-10.csv%';
```

---

## 4) Typical investigations

### A) Type conversion issues
```sql
SELECT FILE, LINE, FIRST_ERROR_COLUMN, ERROR_MESSAGE
FROM t_validation
WHERE ERROR_MESSAGE ILIKE '%numeric%';
```

### B) Column count mismatch
```sql
SELECT FILE, LINE, ERROR_MESSAGE
FROM t_validation
WHERE ERROR_MESSAGE ILIKE '%Number of columns%'
   OR ERROR_MESSAGE ILIKE '%delimited%';
```

### C) Summary per file
```sql
SELECT FILE, STATUS, ROWS_PARSED, ERRORS_SEEN
FROM t_validation
ORDER BY ERRORS_SEEN DESC, FILE;
```

---

## 5) Use query id for audit
```sql
SET v_qid = (SELECT LAST_QUERY_ID());

CREATE OR REPLACE TEMP TABLE t_validation AS
SELECT *
FROM TABLE(RESULT_SCAN($v_qid));
```

---

## 6) Validate specific files
```sql
COPY INTO COPY_DB.PUBLIC.ORDERS
FROM @COPY_DB.PUBLIC.aws_stage_copy
FILES = ('orders_2025_08_10.csv','orders_2025_08_11.csv')
FILE_FORMAT = (TYPE=CSV FIELD_DELIMITER=',' SKIP_HEADER=1)
VALIDATION_MODE = RETURN_ERRORS;

CREATE OR REPLACE TEMP TABLE t_validation AS
SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
```

---

## 7) COPY options for strict validation

### A) Enforce column count
```sql
COPY INTO COPY_DB.PUBLIC.ORDERS
FROM @COPY_DB.PUBLIC.aws_stage_copy
FILE_FORMAT = (
  TYPE = CSV
  FIELD_DELIMITER = ','
  SKIP_HEADER = 1
  ERROR_ON_COLUMN_COUNT_MISMATCH = TRUE
)
VALIDATION_MODE = RETURN_ERRORS;

SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));
```

### B) Quoting issues
```sql
COPY INTO COPY_DB.PUBLIC.ORDERS
FROM @COPY_DB.PUBLIC.aws_stage_copy
FILE_FORMAT = (TYPE=CSV FIELD_DELIMITER=',' SKIP_HEADER=1)
VALIDATION_MODE = RETURN_10_ROWS;

-- If errors point to quoting, retry:
COPY INTO COPY_DB.PUBLIC.ORDERS
FROM @COPY_DB.PUBLIC.aws_stage_copy
FILE_FORMAT = (
  TYPE=CSV
  FIELD_DELIMITER=','
  SKIP_HEADER=1
  FIELD_OPTIONALLY_ENCLOSED_BY='"'
)
VALIDATION_MODE = RETURN_10_ROWS;
```

---

## 8) Export errors to stage
```sql
CREATE OR REPLACE TABLE audit.copy_validation_errors AS
SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));

COPY INTO @~ /validation_errors/
FROM audit.copy_validation_errors
FILE_FORMAT = (TYPE=CSV, COMPRESSION=GZIP)
HEADER=TRUE
OVERWRITE=TRUE;
```

---

## 9) End-to-end Example
```sql
-- Validate first 5 rows
COPY INTO COPY_DB.PUBLIC.ORDERS
FROM @COPY_DB.PUBLIC.aws_stage_copy
FILE_FORMAT = (TYPE=CSV FIELD_DELIMITER=',' SKIP_HEADER=1)
PATTERN = '.*Order.*'
VALIDATION_MODE = RETURN_5_ROWS;

-- Capture results
CREATE OR REPLACE TEMP TABLE t_validation AS
SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));

-- Summary
SELECT FILE, STATUS, ROWS_PARSED, ERRORS_SEEN
FROM t_validation
ORDER BY ERRORS_SEEN DESC;

-- Detailed failures
SELECT FILE, LINE, FIRST_ERROR_COLUMN, ERROR_MESSAGE
FROM t_validation
WHERE ERROR_MESSAGE IS NOT NULL OR STATUS ILIKE '%FAIL%';

-- Final load
COPY INTO COPY_DB.PUBLIC.ORDERS
FROM @COPY_DB.PUBLIC.aws_stage_copy
FILE_FORMAT = (TYPE=CSV FIELD_DELIMITER=',' SKIP_HEADER=1)
PATTERN = '.*Order.*'
ON_ERROR = 'ABORT_STATEMENT';
```
